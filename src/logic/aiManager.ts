// src/logic/aiManager.ts

export type Keyword = {
  id: string;
  label: string;
  isDynamic: boolean;
};

//////////////////////////////////////////////////////
// STATIC KEYWORDS (ALWAYS AVAILABLE)
//////////////////////////////////////////////////////

const STATIC_KEYWORDS: Keyword[] = [
  { id: 'HELP', label: 'HELP', isDynamic: false },
  { id: 'EMERGENCY', label: 'EMERGENCY', isDynamic: false },
  { id: 'PAIN', label: 'PAIN', isDynamic: false },
];

//////////////////////////////////////////////////////
// FALLBACK OBJECT (IF GEMINI FAILS)
//////////////////////////////////////////////////////

const FALLBACK_OBJECT = "OBJECT";

//////////////////////////////////////////////////////
// MAIN FUNCTION
//////////////////////////////////////////////////////

export function getActiveKeywords(
  detectedObjects?: string[]
): Keyword[] {

  //////////////////////////////////////////////////////
  // SAFETY: ensure valid array
  //////////////////////////////////////////////////////

  const safeObjects: string[] =
    Array.isArray(detectedObjects)
      ? detectedObjects
      : [];



  //////////////////////////////////////////////////////
  // CLEAN + NORMALIZE OBJECT NAMES
  //////////////////////////////////////////////////////

  const cleanedObjects: string[] =
    safeObjects
      .filter(obj =>
        obj !== undefined &&
        obj !== null &&
        obj.toString().trim().length > 0
      )
      .map(obj =>
        obj.toString().trim().toUpperCase()
      );



  //////////////////////////////////////////////////////
  // REMOVE DUPLICATES
  //////////////////////////////////////////////////////

  const uniqueObjects: string[] =
    Array.from(new Set(cleanedObjects));



  //////////////////////////////////////////////////////
  // LIMIT TO TOP 2 OBJECTS
  //////////////////////////////////////////////////////

  let selectedObjects: string[] =
    uniqueObjects.slice(0, 2);



  //////////////////////////////////////////////////////
  // FALLBACK IF NONE DETECTED
  //////////////////////////////////////////////////////

  if (selectedObjects.length === 0) {

    selectedObjects = [FALLBACK_OBJECT];

  }



  //////////////////////////////////////////////////////
  // CREATE SAFE DYNAMIC KEYWORDS
  //////////////////////////////////////////////////////

  const dynamicKeywords: Keyword[] =
    selectedObjects.map(obj => ({

      id: obj || FALLBACK_OBJECT,

      label: obj || FALLBACK_OBJECT,

      isDynamic: true,

    }));



  //////////////////////////////////////////////////////
  // FINAL SAFE RETURN
  //////////////////////////////////////////////////////

  return [

    ...STATIC_KEYWORDS,

    ...dynamicKeywords,

  ];

}